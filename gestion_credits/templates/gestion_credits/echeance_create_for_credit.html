{% extends 'gestion_credits/base.html' %}
{% load static %}

{% block title %}Ajouter un Paiement - {{ credit.client.nom_complet }} - Sanlam Cr√©dits{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'gestion_credits/css/echeance_form.css' %}">
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-plus-circle text-success"></i>
        Ajouter un Paiement
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{% url 'gestion_credits:credit_detail' credit.pk %}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Retour au cr√©dit
        </a>
    </div>
</div>

<!-- Messages d'erreur et de succ√®s -->
{% if messages %}
<div class="mb-4">
    {% for message in messages %}
    <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
        <i class="bi bi-{% if message.tags == 'error' %}exclamation-triangle{% elif message.tags == 'success' %}check-circle{% else %}info-circle{% endif %}"></i>
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="row">
    <!-- Informations du cr√©dit -->
    <div class="col-md-4 mb-4">
        <div class="card shadow h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-credit-card"></i>
                    D√©tails du Cr√©dit
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong><i class="bi bi-person text-primary"></i> Client :</strong>
                    <br>
                    <a href="{% url 'gestion_credits:client_detail' credit.client.pk %}" class="text-decoration-none">
                        {{ credit.client.nom_complet }}
                    </a>
                </div>
                
                <div class="mb-3">
                    <strong><i class="bi bi-currency-exchange text-success"></i> Montant Total :</strong>
                    <br>
                    <span class="h5 text-success">{{ credit.montant_total|floatformat:2 }} DH</span>
                </div>
                
                <div class="mb-3">
                    <strong><i class="bi bi-collection text-info"></i> Type :</strong>
                    <br>
                    <span class="badge bg-primary">{{ credit.get_type_credit_display }}</span>
                </div>
                
                {% if credit.description %}
                <div class="mb-3">
                    <strong><i class="bi bi-text-paragraph text-secondary"></i> Description :</strong>
                    <br>
                    <small class="text-muted">{{ credit.description }}</small>
                </div>
                {% endif %}
                
                <hr>
                
                <div class="text-center">
                    <div class="row">
                        <div class="col-6">
                            <h4 class="text-success mb-0">{{ total_paye|floatformat:2 }} DH</h4>
                            <small class="text-muted">Total Pay√©</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-warning mb-0">{{ reste_a_payer|floatformat:2 }} DH</h4>
                            <small class="text-muted">Reste √† Payer</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
        <!-- Barre de progression -->
        <div class="card shadow mt-3">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="bi bi-percent"></i>
                    Progression du Paiement
                </h6>
            </div>
            <div class="card-body">
                {% if credit.montant_total > 0 %}
                {% widthratio total_paye credit.montant_total 100 as pourcentage %}
                <div class="progress mb-2" style="height: 25px;">
                    <div class="progress-bar bg-success" role="progressbar" 
                         style="width: {{ pourcentage }}%" 
                         aria-valuenow="{{ pourcentage }}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                        {{ pourcentage }}%
                    </div>
                </div>
                <small class="text-muted">
                    {{ total_paye|floatformat:2 }} DH sur {{ credit.montant_total|floatformat:2 }} DH
                </small>
                {% else %}
                <div class="text-center text-muted">
                    <i class="bi bi-info-circle"></i>
                    Aucun montant d√©fini
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Ch√®ques de Garantie -->
        {% if cheques_garantie %}
        <div class="card shadow mt-3">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">
                    <i class="bi bi-bank"></i>
                    Ch√®ques de Garantie
                </h6>
            </div>
            <div class="card-body p-0">
                <!-- Ch√®ques Non Vers√©s -->
                {% if cheques_non_verses %}
                <div class="p-3 border-bottom">
                    <h6 class="text-warning mb-3">
                        <i class="bi bi-clock"></i> Ch√®ques Non Vers√©s (√† Encaisser)
                    </h6>
                    <div class="row">
                        {% for cheque in cheques_non_verses %}
                        <div class="col-md-6 mb-2">
                            <div class="card border-warning h-100">
                                <div class="card-body p-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong class="text-dark">{{ cheque.numero }}</strong>
                                            <br>
                                            <small class="text-muted">{{ cheque.banque }}</small>
                                            <br>
                                            <span class="text-success fw-bold">{{ cheque.montant|floatformat:2 }} DH</span>
                                        </div>
                                        <div class="text-end">
                                            <small class="text-muted d-block">√âch√©ance:</small>
                                            <small class="text-warning">{{ cheque.date_echeance|date:"d/m/Y" }}</small>
                                            <br>
                                            <span class="badge bg-warning badge-sm">
                                                <i class="bi bi-clock"></i> Non vers√©
                                            </span>
                                            <br>
                                            <div class="mt-2">
                                                <button class="btn btn-success btn-sm" 
                                                        onclick="togglePaiementDirect({{ cheque.pk }})">
                                                    <i class="bi bi-cash-coin"></i> Payer en Esp√®ces
                                                </button>
                                            </div>
                                            
                                            <!-- Interface de paiement direct sur place -->
                                            <div id="paiement-direct-{{ cheque.pk }}" class="mt-2" style="display: none;">
                                                <form method="post" action="{% url 'gestion_credits:payer_cheque_especes' credit.pk %}" class="p-2 border rounded bg-light">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="cheque_id" value="{{ cheque.pk }}">
                                                    <input type="hidden" name="montant" value="{{ cheque.montant }}">
                                                    
                                                    <div class="mb-2">
                                                        <label class="form-label small mb-1">Date de paiement:</label>
                                                        <input type="date" name="date_paiement" value="{{ today|date:'Y-m-d' }}" 
                                                               class="form-control form-control-sm" required>
                                                    </div>
                                                    
                                                    <div class="mb-2">
                                                        <label class="form-label small mb-1">Commentaire:</label>
                                                        <input type="text" name="commentaire" 
                                                               placeholder="Paiement en esp√®ces du ch√®que" 
                                                               class="form-control form-control-sm">
                                                    </div>
                                                    
                                                    <div class="d-flex gap-1">
                                                        <button type="submit" class="btn btn-success btn-sm flex-fill">
                                                            <i class="bi bi-check"></i> Confirmer
                                                        </button>
                                                        <button type="button" class="btn btn-secondary btn-sm" 
                                                                onclick="togglePaiementDirect({{ cheque.pk }})">
                                                            <i class="bi bi-x"></i> Annuler
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Ch√®ques Vers√©s -->
                {% if cheques_verses %}
                <div class="p-3">
                    <h6 class="text-success mb-3">
                        <i class="bi bi-check-circle"></i> Ch√®ques Vers√©s (Encaiss√©s)
                    </h6>
                    <div class="row">
                        {% for cheque in cheques_verses %}
                        <div class="col-md-6 mb-2">
                            <div class="card border-success h-100">
                                <div class="card-body p-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong class="text-dark">{{ cheque.numero }}</strong>
                                            <br>
                                            <small class="text-muted">{{ cheque.banque }}</small>
                                            <br>
                                            <span class="text-success fw-bold">{{ cheque.montant|floatformat:2 }} DH</span>
                                        </div>
                                        <div class="text-end">
                                            <small class="text-muted d-block">√âch√©ance:</small>
                                            <small class="text-success">{{ cheque.date_echeance|date:"d/m/Y" }}</small>
                                            <br>
                                            <span class="badge bg-success badge-sm">
                                                <i class="bi bi-check-circle"></i> Vers√©
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Aucun ch√®que -->
                {% if not cheques_non_verses and not cheques_verses %}
                <div class="p-3 text-center text-muted">
                    <i class="bi bi-info-circle"></i>
                    Aucun ch√®que de garantie enregistr√© pour ce cr√©dit.
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Formulaire d'ajout de paiement -->
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-plus-circle"></i>
                    Nouveau Paiement
                </h5>
            </div>
            <div class="card-body">
                <form method="post" id="paiement-form">
                    {% csrf_token %}
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Rappel :</strong> Vous pouvez ajouter des paiements en esp√®ces ou des effets (ch√®ques) pour r√©duire le montant restant du cr√©dit.
                    </div>
                    
                    <!-- Type de paiement -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="bi bi-credit-card"></i> Type de Paiement *
                        </label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="type_paiement" id="type_especes" value="especes" checked>
                            <label class="form-check-label" for="type_especes">
                                <i class="bi bi-cash text-success"></i> Esp√®ces
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="type_paiement" id="type_effet" value="effet">
                            <label class="form-check-label" for="type_effet">
                                <i class="bi bi-bank text-info"></i> Effet (Ch√®que)
                                    </label>
                        </div>
                                </div>
                                
                    <!-- Montant -->
                    <div class="mb-3">
                                    <label class="form-label">
                                        <i class="bi bi-currency-exchange"></i> Montant (DH) *
                                    </label>
                        <input type="number" name="montant" class="form-control" required
                               step="0.01" min="0.01" max="{{ reste_a_payer }}"
                               placeholder="Montant du paiement">
                        <div class="form-text">
                            Montant maximum autoris√© : <strong>{{ reste_a_payer|floatformat:2 }} DH</strong>
                                </div>
                            </div>
                            
                    <!-- Date de paiement -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="bi bi-calendar"></i> Date de Paiement *
                        </label>
                        <input type="date" name="date_paiement" class="form-control" required
                               max="{{ today|date:'Y-m-d' }}" value="{{ today|date:'Y-m-d' }}">
                        <div class="form-text">Date √† laquelle le paiement a √©t√© effectu√©</div>
                    </div>
                    
                    <!-- Commentaire -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="bi bi-text-paragraph"></i> Commentaire
                        </label>
                        <textarea name="commentaire" class="form-control" rows="3" 
                                  placeholder="Description du paiement, r√©f√©rence, etc."></textarea>
                    </div>
                    
                    <!-- Champs sp√©cifiques aux effets (initialement cach√©s) -->
                    <div id="champs-effet" style="display: none;">
                        <hr>
                        <h6 class="text-info">
                            <i class="bi bi-bank"></i> Informations de l'Effet (Ch√®que)
                        </h6>
                        
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">
                                    <i class="bi bi-123"></i> R√©f√©rence du Ch√®que *
                                    </label>
                                <input type="text" name="numero_effet" class="form-control" required
                                       placeholder="Num√©ro du ch√®que">
                                <div class="form-text">Num√©ro de r√©f√©rence du ch√®que</div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">
                                    <i class="bi bi-bank"></i> Nom de la Banque *
                                    </label>
                                <input type="text" name="banque" class="form-control" required
                                       placeholder="Ex: BMCE, Attijariwafa Bank...">
                                <div class="form-text">Nom de la banque √©mettrice</div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">
                                    <i class="bi bi-calendar-event"></i> Date de R√©alisation du Ch√®que *
                                    </label>
                                <input type="date" name="date_emission" class="form-control" required
                                       max="{{ today|date:'Y-m-d' }}" value="{{ today|date:'Y-m-d' }}">
                                <div class="form-text">Date √† laquelle le ch√®que a √©t√© √©mis</div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">
                                    <i class="bi bi-calendar-check"></i> Date d'√âch√©ance du Ch√®que *
                                </label>
                                <input type="date" name="date_echeance" class="form-control" required
                                       min="{{ today|date:'Y-m-d' }}">
                                <div class="form-text">Date √† laquelle le ch√®que doit √™tre encaiss√©</div>
                            </div>
                        </div>
                        
                        <!-- Statut du ch√®que -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-check-circle"></i> Statut du Ch√®que *
                            </label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="statut_cheque" id="statut_non_verse" value="non_verse" checked>
                                <label class="form-check-label" for="statut_non_verse">
                                    <i class="bi bi-clock text-warning"></i> Non vers√© (√† encaisser)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="statut_cheque" id="statut_verse" value="verse">
                                <label class="form-check-label" for="statut_verse">
                                    <i class="bi bi-check-circle text-success"></i> Vers√© (d√©j√† encaiss√©)
                                    </label>
                            </div>
                            <div class="form-text">
                                Indiquez si le ch√®que a d√©j√† √©t√© encaiss√© ou s'il est encore √† encaisser
                                </div>
                            </div>
                        
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>Important :</strong> Pour un paiement par effet, le montant sera automatiquement celui du ch√®que. 
                            Assurez-vous que la r√©f√©rence et les informations du ch√®que sont correctes.
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'gestion_credits:credit_detail' credit.pk %}" class="btn btn-secondary me-md-2">
                            <i class="bi bi-x-circle"></i> Annuler
                        </a>
                        

                        
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-plus-circle"></i> Ajouter le Paiement
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Historique des paiements -->
        {% if reglements %}
        <div class="card shadow mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history"></i>
                    Historique des Paiements
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Montant</th>
                                <th>Statut</th>
                                <th>Commentaire</th>
                                <th>Agent</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reglement in reglements %}
                            <tr>
                                <td>{{ reglement.date_reglement|date:"d/m/Y" }}</td>
                                <td>
                                    {% if reglement.mode_paiement == 'especes' %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-cash"></i> Esp√®ces
                                        </span>
                                    {% elif reglement.mode_paiement == 'cheque' %}
                                        <span class="badge bg-info">
                                            <i class="bi bi-bank"></i> Effet
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ reglement.get_mode_paiement_display }}</span>
                                    {% endif %}
                                </td>
                                <td class="fw-bold">{{ reglement.montant|floatformat:2 }} DH</td>
                                <td>
                                    {% if reglement.statut == 'verse' %}
                                        <span class="badge bg-success">Vers√©</span>
                                    {% elif reglement.statut == 'non_verse' %}
                                        <span class="badge bg-warning">Non vers√©</span>
                                    {% else %}
                                        <span class="badge bg-secondary">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">{{ reglement.commentaire|truncatechars:50 }}</small>
                                </td>
                                <td>
                                    <small class="text-muted">{{ reglement.agent.username }}</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Script de paiement charg√©');
    
    // R√©cup√©rer les √©l√©ments essentiels
    const form = document.getElementById('paiement-form');
    const typeEspeces = document.getElementById('type_especes');
    const typeEffet = document.getElementById('type_effet');
    const champsEffet = document.getElementById('champs-effet');
    const montantInput = document.querySelector('input[name="montant"]');
    
    console.log('üîç √âl√©ments trouv√©s:', {
        form: !!form,
        typeEspeces: !!typeEspeces,
        typeEffet: !!typeEffet,
        champsEffet: !!champsEffet,
        montantInput: !!montantInput
    });
    
    if (!form) {
        console.error('‚ùå Formulaire non trouv√© !');
        return;
    }
    
    // Fonction simple pour afficher/masquer les champs d'effet
    function toggleChampsEffet() {
        if (typeEffet && typeEffet.checked) {
            if (champsEffet) {
                champsEffet.style.display = 'block';
                // Rendre les champs obligatoires
                champsEffet.querySelectorAll('input').forEach(input => {
                    input.required = true;
                });
            }
        } else {
            if (champsEffet) {
                champsEffet.style.display = 'none';
                // Rendre les champs optionnels
                champsEffet.querySelectorAll('input').forEach(input => {
                    input.required = false;
                });
            }
        }
    }
    
    // √âcouteurs d'√©v√©nements pour le type de paiement
    if (typeEspeces) {
        typeEspeces.addEventListener('change', toggleChampsEffet);
    }
    if (typeEffet) {
        typeEffet.addEventListener('change', toggleChampsEffet);
    }
    
    // Validation simple avant soumission
    form.addEventListener('submit', function(e) {
        console.log('üîÑ Formulaire en cours de soumission...');
        
        // R√©cup√©rer les valeurs
        const typePaiement = document.querySelector('input[name="type_paiement"]:checked');
        const montant = montantInput ? montantInput.value : '';
        const datePaiement = document.querySelector('input[name="date_paiement"]');
        
        console.log('üìù Donn√©es:', {
            typePaiement: typePaiement ? typePaiement.value : 'non s√©lectionn√©',
            montant: montant,
            datePaiement: datePaiement ? datePaiement.value : 'non saisie'
        });
        
        // Validation de base
        if (!typePaiement) {
            console.log('‚ùå Type de paiement non s√©lectionn√©');
            e.preventDefault();
            alert('Veuillez s√©lectionner un type de paiement.');
            return false;
        }
        
        if (!montant || montant <= 0) {
            console.log('‚ùå Montant invalide');
            e.preventDefault();
            alert('Veuillez saisir un montant valide sup√©rieur √† 0.');
            if (montantInput) montantInput.focus();
            return false;
        }
        
        if (!datePaiement || !datePaiement.value) {
            console.log('‚ùå Date de paiement manquante');
            e.preventDefault();
            alert('Veuillez saisir une date de paiement.');
            if (datePaiement) datePaiement.focus();
            return false;
        }
        
        // Validation des champs d'effet si n√©cessaire
        if (typePaiement.value === 'effet') {
            console.log('üè¶ Validation des champs d\'effet...');
            
            const banque = document.querySelector('input[name="banque"]');
            const numeroEffet = document.querySelector('input[name="numero_effet"]');
            const dateEmission = document.querySelector('input[name="date_emission"]');
            const dateEcheance = document.querySelector('input[name="date_echeance"]');
            const statutCheque = document.querySelector('input[name="statut_cheque"]:checked');
            
            if (!banque || !banque.value.trim()) {
                e.preventDefault();
                alert('Veuillez saisir le nom de la banque.');
                if (banque) banque.focus();
                return false;
            }
            
            if (!numeroEffet || !numeroEffet.value.trim()) {
                e.preventDefault();
                alert('Veuillez saisir la r√©f√©rence du ch√®que.');
                if (numeroEffet) numeroEffet.focus();
                return false;
            }
            
            if (!dateEmission || !dateEmission.value) {
                e.preventDefault();
                alert('Veuillez saisir la date d\'√©mission du ch√®que.');
                if (dateEmission) dateEmission.focus();
            return false;
        }
            
            if (!dateEcheance || !dateEcheance.value) {
                e.preventDefault();
                alert('Veuillez saisir la date d\'√©ch√©ance du ch√®que.');
                if (dateEcheance) dateEcheance.focus();
                return false;
            }

            if (!statutCheque) {
            e.preventDefault();
                alert('Veuillez s√©lectionner le statut du ch√®que (vers√© ou non vers√©).');
                return false;
            }
        }
        
        console.log('‚úÖ Validation r√©ussie, soumission autoris√©e');
        console.log('üì§ Envoi du formulaire...');
        
        // Le formulaire peut √™tre soumis
        return true;
    });
    
    // Initialisation
    toggleChampsEffet();
    
    console.log('‚úÖ Script de paiement initialis√© avec succ√®s');
    
    // Test de clic sur le bouton
    const submitButton = form.querySelector('button[type="submit"]');
    if (submitButton) {
        console.log('üîò Bouton de soumission trouv√©:', submitButton.textContent);
        
        // Ajouter un √©couteur de clic pour d√©boguer
        submitButton.addEventListener('click', function(e) {
            console.log('üñ±Ô∏è Bouton cliqu√© !');
        });
    } else {
        console.error('‚ùå Bouton de soumission non trouv√© !');
    }
});

// Fonction pour afficher/masquer l'interface de paiement direct
function togglePaiementDirect(chequeId) {
    const paiementDirect = document.getElementById(`paiement-direct-${chequeId}`);
    if (paiementDirect.style.display === 'none') {
        paiementDirect.style.display = 'block';
        // Masquer tous les autres formulaires de paiement direct
        document.querySelectorAll('[id^="paiement-direct-"]').forEach(el => {
            if (el.id !== `paiement-direct-${chequeId}`) {
                el.style.display = 'none';
            }
        });
    } else {
        paiementDirect.style.display = 'none';
    }
}

</script>


{% endblock %}
